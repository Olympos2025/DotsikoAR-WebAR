<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WebAR KML Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- A-Frame & AR.js -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://rawcdn.githack.com/AR-js-org/AR.js/3.4.2/aframe/build/aframe-ar.min.js"></script>

  <!-- Leaflet & Omnivore for KML parsing -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    #fileInput {
      position: absolute;
      top: 1em; left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      background: rgba(255,255,255,0.8);
      padding: .5em 1em;
      border-radius: .3em;
    }
  </style>
</head>
<body>
  <!-- allow the user to load one or more .kml files -->
  <input
    type="file"
    id="fileInput"
    accept=".kml"
    multiple
  />

  <!-- AR.js scene with all the flags needed on iOS Safari -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
    arjs="sourceType: camera;
          debugUIEnabled: false;
          gpsMinDistance: 0;
          gpsMaxDistance: 20000;"
    renderer="logarithmicDepthBuffer: true; antialias: true;"
    webkit-playsinline
    playsinline
  >
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <script>
    const MAX_DISTANCE = 20000; // 20â€‰km

    document
      .getElementById('fileInput')
      .addEventListener('change', function (e) {
        const files = Array.from(e.target.files)
          .filter(f => f.name.toLowerCase().endsWith('.kml'));

        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = () => {
            const blob = new Blob(
              [reader.result],
              { type: 'application/vnd.google-earth.kml+xml' }
            );
            const url = URL.createObjectURL(blob);

            omnivore
              .kml(url)
              .on('ready', function () {
                this.eachLayer(layer => {
                  // get the first ring of coordinates (for Polygons) or a single LatLng
                  let pts = layer.getLatLngs
                    ? layer.getLatLngs()[0]
                    : [ layer.getLatLng() ];

                  pts.forEach(p => {
                    // distance filter
                    navigator.geolocation.getCurrentPosition(pos => {
                      const d = layer._map
                        ? layer._map.distance(
                            [pos.coords.latitude, pos.coords.longitude],
                            [p.lat, p.lng]
                          )
                        : Infinity;
                      if (d > MAX_DISTANCE) return;

                      // create a red translucent sphere at each point
                      const sphere = document.createElement('a-sphere');
                      sphere.setAttribute(
                        'gps-entity-place',
                        `latitude: ${p.lat}; longitude: ${p.lng};`
                      );
                      sphere.setAttribute('radius', '1');
                      sphere.setAttribute('color', '#FF0000');
                      sphere.setAttribute('opacity', '0.6');
                      document.querySelector('a-scene').appendChild(sphere);
                    });
                  });

                  // draw polygon outlines (no fill)
                  if (layer.getLatLngs) {
                    const coords = layer.getLatLngs()[0];
                    for (let i = 0; i < coords.length - 1; i++) {
                      const start = coords[i];
                      const end = coords[i+1];
                      const line = document.createElement('a-entity');
                      line.setAttribute(
                        'line',
                        `start: ${start.lng} ${start.lat} 0;
                         end:   ${end.lng}   ${end.lat} 0;
                         color: #FF0000`
                      );
                      line.setAttribute(
                        'gps-entity-place',
                        `latitude: ${start.lat}; longitude: ${start.lng}`
                      );
                      document.querySelector('a-scene').appendChild(line);
                    }
                  }
                });
              });
          };
          reader.readAsText(file);
        });
      });
  </script>
</body>
</html>
