<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DotsikoAR WebAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame & AR.js -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        #loading {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            z-index: 10000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #kmlInput {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 10000;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }
        #skipGPS {
            position: fixed;
            top: 150px;
            left: 20px;
            z-index: 10000;
            background: #ff4d4d;
            color: white;
            padding: 10px;
            border-radius: 5px;
            border: none;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div id="loading">⌛ Ενεργοποίηση GPS...</div>
    <input type="file" id="kmlInput" accept=".kml">
    <button id="skipGPS">Παράκαμψη GPS</button>
    
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        embedded>

        <a-camera gps-camera rotation-reader></a-camera>
        <a-entity id="kml-container"></a-entity>
    </a-scene>

    <script>
    // Για debugging
    document.write('<script src="https://cdn.jsdelivr.net/npm/eruda"><\/script>');
    document.write('<script>eruda.init();<\/script>');

    // Μεταβλητές
    let userPosition = null;
    let gpsTimeout;

    // Χειρισμός αρχείου KML
    document.getElementById('kmlInput').addEventListener('change', handleFileUpload);

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const polygons = parseKML(e.target.result);
                if (!polygons || polygons.length === 0) {
                    alert("Δεν βρέθηκαν πολύγωνα στο KML! Ελέγξτε τη δομή του αρχείου.");
                    console.log("Περιεχόμενο KML:", e.target.result);
                } else {
                    document.getElementById('kml-container').innerHTML = '';
                    polygons.forEach(polygon => addPolygonToAR(polygon));
                    alert(`Βρέθηκαν ${polygons.length} πολύγωνα και προστέθηκαν στο AR!`);
                }
            } catch (err) {
                console.error("Σφάλμα επεξεργασίας KML:", err);
                alert("Σφάλμα επεξεργασίας KML: " + err.message);
            }
        };
        reader.readAsText(file);
    }

    // Βελτιωμένος KML Parser
    function parseKML(kmlText) {
        console.log("Ανάλυση KML:", kmlText.substring(0, 500) + "...");
        
        const parser = new DOMParser();
        const kmlDoc = parser.parseFromString(kmlText, "text/xml");
        
        // Έλεγχος για σφάλματα parsing
        if (kmlDoc.getElementsByTagName('parsererror').length > 0) {
            throw new Error("Μη έγκυρο XML/KML αρχείο");
        }
        
        // Εμφάνιση του αριθμού των Placemarks
        const placemarks = kmlDoc.getElementsByTagName('Placemark');
        console.log(`Βρέθηκαν ${placemarks.length} Placemarks`);
        
        // Ψάχνουμε για Polygon, MultiGeometry, και LineString
        const polygons = [];
        
        for (const placemark of placemarks) {
            // 1. Έλεγχος για απλά πολύγωνα
            const polygonElements = placemark.getElementsByTagName('Polygon');
            for (const poly of polygonElements) {
                const coords = extractCoordinates(poly);
                if (coords && coords.length > 2) {
                    polygons.push(coords);
                    console.log(`Βρέθηκε πολύγωνο με ${coords.length} σημεία`);
                }
            }
            
            // 2. Έλεγχος για MultiGeometry
            const multiGeo = placemark.getElementsByTagName('MultiGeometry');
            for (const geo of multiGeo) {
                const multiPolys = geo.getElementsByTagName('Polygon');
                for (const poly of multiPolys) {
                    const coords = extractCoordinates(poly);
                    if (coords && coords.length > 2) {
                        polygons.push(coords);
                        console.log(`Βρέθηκε πολύγωνο σε MultiGeometry με ${coords.length} σημεία`);
                    }
                }
            }
            
            // 3. Έλεγχος για LineString (γραμμές που μπορούν να θεωρηθούν πολύγωνα)
            const lineStrings = placemark.getElementsByTagName('LineString');
            for (const line of lineStrings) {
                const coords = extractCoordinates(line);
                if (coords && coords.length > 2) {
                    polygons.push(coords);
                    console.log(`Βρέθηκε LineString με ${coords.length} σημεία`);
                }
            }
        }
        
        return polygons;
    }

    // Βοηθητική συνάρτηση για εξαγωγή συντεταγμένων από στοιχείο
    function extractCoordinates(element) {
        const coordsElem = element.getElementsByTagName('coordinates')[0];
        if (!coordsElem) return null;
        
        const coordsText = coordsElem.textContent.trim();
        const pairs = coordsText.split(/\s+/);
        
        const points = [];
        for (const pair of pairs) {
            const values = pair.split(',');
            if (values.length >= 2) {
                const lon = parseFloat(values[0]);
                const lat = parseFloat(values[1]);
                if (!isNaN(lon) && !isNaN(lat)) {
                    points.push({lat, lon});
                }
            }
        }
        
        return points;
    }

    // Προσθήκη πολυγώνου στο AR
    function addPolygonToAR(polygon) {
        // Υπολογισμός κέντρου πολυγώνου
        let avgLat = 0, avgLon = 0;
        polygon.forEach(p => { 
            avgLat += p.lat; 
            avgLon += p.lon; 
        });
        avgLat /= polygon.length;
        avgLon /= polygon.length;
        
        // Δημιουργία γραμμών για το περίγραμμα
        for (let i = 0; i < polygon.length; i++) {
            const p1 = polygon[i];
            const p2 = polygon[(i+1) % polygon.length];
            
            // Δημιουργία γραμμής μεταξύ δύο σημείων
            const line = document.createElement('a-entity');
            line.setAttribute('gps-entity-place', `latitude: ${p1.lat}; longitude: ${p1.lon}`);
            
            // Υπολογισμός διαφοράς σε μέτρα μεταξύ των σημείων
            const dx = geoToMeters(p1.lat, p1.lon, p2.lat, p2.lon);
            
            line.setAttribute('line', {
                start: '0 0 0',
                end: `${dx.x} 0 ${dx.z}`,
                color: 'red',
                opacity: 0.8,
                width: 5
            });
            
            document.getElementById('kml-container').appendChild(line);
        }
        
        // Προσθήκη διαφανούς επιφάνειας στο κέντρο του πολυγώνου
        const surface = document.createElement('a-entity');
        surface.setAttribute('gps-entity-place', `latitude: ${avgLat}; longitude: ${avgLon}`);
        
        // Υπολογισμός μεγέθους σε μέτρα (απλοποιημένο)
        const size = calculatePolygonSize(polygon);
        
        surface.setAttribute('geometry', {
            primitive: 'plane',
            width: size,
            height: size
        });
        
        surface.setAttribute('material', {
            color: 'blue',
            opacity: 0.3,
            transparent: true,
            side: 'double'
        });
        
        surface.setAttribute('rotation', '-90 0 0');
        document.getElementById('kml-container').appendChild(surface);
    }

    // Υπολογισμός μεγέθους πολυγώνου
    function calculatePolygonSize(polygon) {
        let minLat = 90, maxLat = -90;
        let minLon = 180, maxLon = -180;
        
        polygon.forEach(point => {
            minLat = Math.min(minLat, point.lat);
            maxLat = Math.max(maxLat, point.lat);
            minLon = Math.min(minLon, point.lon);
            maxLon = Math.max(maxLon, point.lon);
        });
        
        // Μετατροπή σε μέτρα και επιλογή του μεγαλύτερου
        const width = geoToMeters(minLat, minLon, minLat, maxLon).x;
        const height = geoToMeters(minLat, minLon, maxLat, minLon).z;
        
        return Math.max(width, height);
    }

    // Μετατροπή γεωγραφικών συντεταγμένων σε μέτρα
    function geoToMeters(lat1, lon1, lat2, lon2) {
        const R = 6378137; // ακτίνα της Γης σε μέτρα
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const lat1Rad = lat1 * Math.PI / 180;
        
        const x = R * dLon * Math.cos(lat1Rad);
        const z = R * dLat;
        
        return { x, z };
    }

    // Χειρισμός GPS
    document.addEventListener('DOMContentLoaded', function() {
        // Ορίζουμε timeout 15 δευτερολέπτων για το GPS
        gpsTimeout = setTimeout(function() {
            document.getElementById('loading').innerHTML = "❌ Αποτυχία GPS. Δοκιμάστε παράκαμψη ή επανεκκίνηση.";
        }, 15000);
        
        // Παράκαμψη GPS
        document.getElementById('skipGPS').addEventListener('click', function() {
            clearTimeout(gpsTimeout);
            document.getElementById('loading').style.display = 'none';
            
            // Χρησιμοποιούμε σταθερή τοποθεσία
            userPosition = {latitude: 40.6401, longitude: 22.9444};
            alert("Το GPS παρακάμφθηκε. Μπορείτε να ανεβάσετε KML αλλά η ευθυγράμμιση θα είναι προσεγγιστική.");
        });
    });

    // Listener για το πότε το ARjs/GPS-camera έχει θέση
    const camera = document.querySelector('a-camera');
    camera.addEventListener('gps-camera-update-position', function(e) {
        clearTimeout(gpsTimeout);
        document.getElementById('loading').style.display = 'none';
        userPosition = e.detail.position;
        console.log('GPS ενεργό!', userPosition);
    });
    </script>
</body>
</html>
