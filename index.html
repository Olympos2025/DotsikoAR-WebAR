<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8">
  <title>WebAR KML Polygon Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    #loading {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px 16px;
      border-radius: 10px;
      z-index: 10;
      font-size: 1.1em;
      box-shadow: 0 2px 8px #0002;
    }
    #kmlInputLabel {
      position: absolute;
      top: 60px;
      left: 10px;
      z-index: 10;
      background: #f2f2f2;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 1em;
      box-shadow: 0 2px 8px #0002;
      cursor: pointer;
    }
    #kmlInput {
      display: none;
    }
    #msg {
      position: absolute;
      top: 110px;
      left: 10px;
      z-index: 10;
      background: #fffbe6;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 1em;
      color: #444;
      display: none;
    }
  </style>
</head>
<body style="margin:0; overflow:hidden;">

  <div id="loading">âŒ› Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· GPS...</div>
  <label id="kmlInputLabel" for="kmlInput">ğŸ“‚ Î¦ÏŒÏÏ„Ï‰ÏƒÎµ Î±ÏÏ‡ÎµÎ¯Î¿ KML</label>
  <input type="file" id="kmlInput" accept=".kml">
  <div id="msg"></div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true;"
  >
    <a-camera gps-camera rotation-reader></a-camera>
    <a-entity id="polygon-container"></a-entity>
  </a-scene>

  <script>
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î¼Î·Î½Ï…Î¼Î¬Ï„Ï‰Î½
    function showMsg(txt) {
      const msg = document.getElementById('msg');
      msg.innerText = txt;
      msg.style.display = 'block';
      setTimeout(() => { msg.style.display = 'none'; }, 4000);
    }

    // Parse KML ÏƒÎµ array Î±Ï€ÏŒ polygons (ÎºÎ¬Î¸Îµ polygon: array Î±Ï€ÏŒ {lat, lon})
    function parseKML(text) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "text/xml");
      const polygons = [];
      const polygonElems = xml.getElementsByTagName("Polygon");
      for (let poly of polygonElems) {
        const coordsElem = poly.getElementsByTagName("coordinates")[0];
        if (!coordsElem) continue;
        const coordsText = coordsElem.textContent.trim();
        const coordPairs = coordsText.split(/\s+/);
        const points = [];
        for (let pair of coordPairs) {
          const [lon, lat] = pair.split(',').map(Number);
          if (!isNaN(lat) && !isNaN(lon)) {
            points.push({ lat, lon });
          }
        }
        if (points.length > 2) polygons.push(points);
      }
      return polygons;
    }

    // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Î³ÎµÏ‰Î³ÏÎ±Ï†Î¹ÎºÏÎ½ ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½Ï‰Î½ ÏƒÎµ Ï„Î¿Ï€Î¹ÎºÎ­Ï‚ Î±Ï€Î¿ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚ (ÏƒÎµ Î¼Î­Ï„ÏÎ±)
    function geoToMeters(lat1, lon1, lat2, lon2) {
      const R = 6378137;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const latRad = lat1 * Math.PI / 180;
      const x = dLon * R * Math.cos(latRad);
      const y = dLat * R;
      return { x, y };
    }

    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± polygon ÏƒÎµ AR (Î¼Îµ gps-entity-place)
    function addPolygonToAR(polygon) {
      // Î“Î¹Î± ÎºÎ¬Î¸Îµ Ï€Î»ÎµÏ…ÏÎ¬ Ï„Î¿Ï… Ï€Î¿Î»Ï…Î³ÏÎ½Î¿Ï…, Ï†Ï„Î¹Î¬Ï‡Î½Î¿Ï…Î¼Îµ Î³ÏÎ±Î¼Î¼Î®
      for (let i = 0; i < polygon.length; i++) {
        const p1 = polygon[i];
        const p2 = polygon[(i+1)%polygon.length];
        const line = document.createElement('a-entity');
        line.setAttribute('gps-entity-place', `latitude: ${p1.lat}; longitude: ${p1.lon}`);
        line.setAttribute('line', `start: 0 0 0; end: 0 0 0.1; color: red`);
        document.getElementById('polygon-container').appendChild(line);
      }
      // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î·Î¼Î¹Î´Î¹Î±Ï†Î±Î½Î¿ÏÏ‚ polygon (Ï‰Ï‚ ÎµÏ€Î¯Ï€ÎµÎ´Î¿)
      // Î¥Ï€Î¿Î»Î¿Î³Î¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿ ÎºÎ­Î½Ï„ÏÎ¿ Î³Î¹Î± Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î·Î¸ÎµÎ¯ Ï„Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿
      let avgLat = 0, avgLon = 0;
      polygon.forEach(p => { avgLat += p.lat; avgLon += p.lon; });
      avgLat /= polygon.length;
      avgLon /= polygon.length;
      const fill = document.createElement('a-entity');
      fill.setAttribute('gps-entity-place', `latitude: ${avgLat}; longitude: ${avgLon}`);
      fill.setAttribute('geometry', `primitive: circle; radius: 10`);
      fill.setAttribute('material', 'color: blue; opacity: 0.3; side: double;');
      fill.setAttribute('rotation', '-90 0 0');
      document.getElementById('polygon-container').appendChild(fill);
    }

    // Î•ÏÏÎµÏƒÎ· Î¸Î­ÏƒÎ·Ï‚ Ï‡ÏÎ®ÏƒÏ„Î· (gps-camera)
    let userLat = null, userLon = null;
    document.querySelector('[gps-camera]').addEventListener('gps-camera-update-position', e => {
      userLat = e.detail.position.latitude;
      userLon = e.detail.position.longitude;
      document.getElementById('loading').style.display = 'none';
      showMsg('âœ… GPS ÎµÎ½ÎµÏÎ³ÏŒ! ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹Ï‚ KML.');
    });

    // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· KML Î±Ï€ÏŒ input
    document.getElementById('kmlInput').addEventListener('change', function(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const polygons = parseKML(e.target.result);
        if (!polygons.length) {
          showMsg('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï€Î¿Î»ÏÎ³Ï‰Î½Î± ÏƒÏ„Î¿ KML!');
          return;
        }
        document.getElementById('polygon-container').innerHTML = '';
        polygons.forEach(polygon => addPolygonToAR(polygon));
        showMsg('Î¤Î¿ Ï€Î¿Î»ÏÎ³Ï‰Î½Î¿ ÎµÎ¼Ï†Î±Î½Î¯ÏƒÏ„Î·ÎºÎµ ÏƒÏ„Î¿ AR!');
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
