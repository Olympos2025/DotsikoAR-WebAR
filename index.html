<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DotsikoAR WebAR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        #loading {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            z-index: 10000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #fileInput {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 10000;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div id="loading">⌛ Ενεργοποίηση GPS...</div>
    <input type="file" id="fileInput" accept=".kml" style="display: none;">
    
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        embedded>

        <a-camera gps-camera rotation-reader></a-camera>
        <a-entity id="kml-container"></a-entity>
    </a-scene>

    <script>
    // Eruda for debugging
    document.write('<script src="https://cdn.jsdelivr.net/npm/eruda"></script>');
    eruda.init();

    document.getElementById('fileInput').addEventListener('change', handleFileUpload);

    function handleFileUpload(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            parseKML(e.target.result)
                .then(polygons => renderPolygons(polygons))
                .catch(err => console.error(err));
        };
        reader.readAsText(file);
    }

    async function parseKML(kmlText) {
        const parser = new DOMParser();
        const kmlDoc = parser.parseFromString(kmlText, "text/xml");
        return Array.from(kmlDoc.querySelectorAll('Placemark')).map(placemark => {
            const coords = placemark.querySelector('coordinates').textContent.trim();
            return coords.split(/\s+/).map(pair => {
                const [lon, lat] = pair.split(',').map(Number);
                return { lat, lon };
            });
        }).filter(polygon => polygon.length > 0);
    }

    function renderPolygons(polygons) {
        const container = document.getElementById('kml-container');
        container.innerHTML = '';
        
        polygons.forEach(polygon => {
            const entity = document.createElement('a-entity');
            
            // Γραμμές ορίου
            polygon.forEach((point, index) => {
                const nextPoint = polygon[(index + 1) % polygon.length];
                const line = document.createElement('a-entity');
                line.setAttribute('line', {
                    start: `${point.lon} 0 ${point.lat}`,
                    end: `${nextPoint.lon} 0 ${nextPoint.lat}`,
                    color: '#FF0000',
                    opacity: 0.8
                });
                entity.appendChild(line);
            });

            // Ημιδιαφανής επιφάνεια
            const fill = document.createElement('a-entity');
            fill.setAttribute('geometry', {
                primitive: 'plane',
                width: Math.abs(polygon[0].lon - polygon[1].lon),
                height: Math.abs(polygon[0].lat - polygon[1].lat)
            });
            fill.setAttribute('material', {
                color: '#00FF00',
                opacity: 0.3,
                transparent: true
            });
            fill.setAttribute('position', `${polygon[0].lon} 0 ${polygon[0].lat}`);
            entity.appendChild(fill);

            container.appendChild(entity);
        });
    }

    // GPS initialization
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                document.getElementById('loading').textContent = "✅ GPS ενεργό";
                startARSession(position.coords);
            },
            error => alert("Απαιτείται άδεια GPS"),
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    function startARSession(coords) {
        // AR.js already initialized via a-scene
        document.getElementById('loading').style.display = 'none';
    }
    </script>
</body>
</html>
