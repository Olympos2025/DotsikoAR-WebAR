<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MapLens - WebAR KML Viewer</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/@tmcw/togeojson@4.6.2"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #10b981;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.15);
            --text: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text);
            overflow: hidden;
        }

        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 1000;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #dc2626);
        }

        .file-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
            width: 0.1px;
            height: 0.1px;
        }

        .status {
            position: fixed;
            top: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 999;
        }

        .status-item {
            padding: 8px 12px;
            border-radius: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-dot.active {
            background: var(--secondary);
        }

        .info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 16px;
            font-size: 14px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 998;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .info.show {
            transform: translateY(0);
        }

        a-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 0 !important;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 995;
            display: none;
        }

        .loading-dots {
            display: flex;
            gap: 8px;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            animation: loading 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>

<body>
    <!-- Controls -->
    <div class="controls">
        <input type="file" id="kml-input" class="file-input" accept=".kml" multiple>
        <label for="kml-input" class="btn btn-primary">
            📁 Φόρτωση KML
        </label>
        
        <button id="test-btn" class="btn">
            🎯 Δοκιμή
        </button>
        
        <button id="clear-btn" class="btn btn-danger">
            🗑️ Καθαρισμός
        </button>
    </div>

    <!-- Status -->
    <div class="status">
        <div class="status-item">
            <span class="status-dot" id="camera-dot"></span>
            <span id="camera-text">Κάμερα</span>
        </div>
        <div class="status-item">
            <span class="status-dot" id="gps-dot"></span>
            <span id="gps-text">GPS</span>
        </div>
        <div class="status-item">
            <span class="status-dot" id="files-dot"></span>
            <span id="files-text">Αρχεία: 0</span>
        </div>
    </div>

    <!-- Info Panel -->
    <div class="info" id="info">
        Φορτώστε ένα KML αρχείο για να ξεκινήσετε
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>

    <!-- AR Scene -->
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        embedded>
        
        <a-camera 
            id="camera"
            gps-new-camera="gpsMinDistance: 5; gpsMaxDistance: 10000;"
            look-controls="enabled: false"
            wasd-controls="enabled: false">
        </a-camera>
        
        <a-entity id="content"></a-entity>
    </a-scene>

    <script>
        class MapLensAR {
            constructor() {
                this.scene = document.querySelector('a-scene');
                this.camera = document.getElementById('camera');
                this.content = document.getElementById('content');
                this.userPosition = null;
                this.features = [];
                
                this.init();
            }

            async init() {
                console.log('🚀 MapLens initializing...');
                
                // Wait for scene
                await this.waitForScene();
                
                // Setup events
                this.setupEvents();
                
                // Initialize GPS and camera
                this.initGPS();
                this.initCamera();
                
                console.log('✅ MapLens ready!');
                this.showInfo('Εφαρμογή έτοιμη! Φορτώστε KML ή πατήστε "Δοκιμή"');
            }

            waitForScene() {
                return new Promise(resolve => {
                    if (this.scene.hasLoaded) {
                        resolve();
                    } else {
                        this.scene.addEventListener('loaded', resolve);
                    }
                });
            }

            setupEvents() {
                // File input
                document.getElementById('kml-input').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.loadFiles(e.target.files);
                    }
                });

                // Test button - creates visible objects regardless of GPS
                document.getElementById('test-btn').addEventListener('click', () => {
                    this.createTestObjects();
                });

                // Clear button
                document.getElementById('clear-btn').addEventListener('click', () => {
                    this.clearAll();
                });

                // Scene click
                this.scene.addEventListener('click', (e) => {
                    const entity = e.detail.intersection?.el;
                    if (entity && entity.dataset.info) {
                        this.showInfo(entity.dataset.info);
                    }
                });
            }

            initGPS() {
                if (!navigator.geolocation) {
                    this.updateStatus('gps', false, 'GPS: Μη διαθέσιμο');
                    return;
                }

                navigator.geolocation.watchPosition(
                    (position) => {
                        this.userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            alt: position.coords.altitude || 0,
                            accuracy: position.coords.accuracy
                        };
                        
                        this.updateStatus('gps', true, `GPS: ±${Math.round(position.coords.accuracy)}m`);
                        console.log('📍 GPS:', this.userPosition);
                    },
                    (error) => {
                        this.updateStatus('gps', false, 'GPS: Σφάλμα');
                        console.error('GPS Error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            }

            initCamera() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(() => {
                            this.updateStatus('camera', true, 'Κάμερα: Ενεργή');
                        })
                        .catch((error) => {
                            this.updateStatus('camera', false, 'Κάμερα: Σφάλμα');
                            console.error('Camera Error:', error);
                        });
                }
            }

            async loadFiles(files) {
                this.showLoading(true);
                let totalFeatures = 0;

                for (const file of files) {
                    try {
                        const features = await this.parseKML(file);
                        this.features.push(...features);
                        totalFeatures += features.length;
                        
                        // Create AR objects for each feature
                        features.forEach(feature => this.createARObject(feature));
                        
                        console.log(`📁 Loaded ${features.length} features from ${file.name}`);
                    } catch (error) {
                        console.error(`❌ Error loading ${file.name}:`, error);
                        this.showInfo(`Σφάλμα: ${error.message}`);
                    }
                }

                this.updateStatus('files', totalFeatures > 0, `Αρχεία: ${totalFeatures}`);
                this.showLoading(false);
                
                if (totalFeatures > 0) {
                    this.showInfo(`✅ Φορτώθηκαν ${totalFeatures} στοιχεία! Κοιτάξτε γύρω σας`);
                } else {
                    this.showInfo('❌ Δεν βρέθηκαν έγκυρα στοιχεία');
                }
            }

            parseKML(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const kmlDoc = new DOMParser().parseFromString(e.target.result, 'text/xml');
                            const features = [];
                            const placemarks = kmlDoc.querySelectorAll('Placemark');
                            
                            placemarks.forEach((placemark, index) => {
                                const name = placemark.querySelector('name')?.textContent || `Στοιχείο ${index + 1}`;
                                const description = placemark.querySelector('description')?.textContent || '';
                                
                                // Parse Polygon
                                const polygon = placemark.querySelector('Polygon outerBoundaryIs LinearRing coordinates');
                                if (polygon) {
                                    const coords = this.parseCoordinates(polygon.textContent);
                                    if (coords.length >= 3) {
                                        features.push({
                                            id: `polygon-${Date.now()}-${index}`,
                                            type: 'Polygon',
                                            name: name,
                                            description: description,
                                            coordinates: coords,
                                            center: this.calculateCenter(coords)
                                        });
                                    }
                                }
                                
                                // Parse Point
                                const point = placemark.querySelector('Point coordinates');
                                if (point) {
                                    const coords = this.parseCoordinates(point.textContent);
                                    if (coords.length > 0) {
                                        features.push({
                                            id: `point-${Date.now()}-${index}`,
                                            type: 'Point',
                                            name: name,
                                            description: description,
                                            coordinates: coords,
                                            center: coords[0]
                                        });
                                    }
                                }
                            });
                            
                            resolve(features);
                        } catch (error) {
                            reject(new Error('Μη έγκυρο KML αρχείο'));
                        }
                    };
                    
                    reader.onerror = () => reject(new Error('Σφάλμα ανάγνωσης'));
                    reader.readAsText(file);
                });
            }

            parseCoordinates(text) {
                const coords = [];
                const pairs = text.trim().split(/\s+/);
                
                pairs.forEach(pair => {
                    const [lng, lat, alt = 0] = pair.split(',').map(parseFloat);
                    if (!isNaN(lng) && !isNaN(lat)) {
                        coords.push({ lng, lat, alt });
                    }
                });
                
                return coords;
            }

            calculateCenter(coords) {
                let totalLat = 0, totalLng = 0, totalAlt = 0;
                coords.forEach(coord => {
                    totalLat += coord.lat;
                    totalLng += coord.lng;
                    totalAlt += coord.alt;
                });
                
                return {
                    lat: totalLat / coords.length,
                    lng: totalLng / coords.length,
                    alt: totalAlt / coords.length
                };
            }

            createARObject(feature) {
                const entity = document.createElement('a-entity');
                entity.setAttribute('data-info', `${feature.name} (${feature.type})\n${feature.description}`);
                
                // Position using GPS
                entity.setAttribute('gps-new-entity-place', {
                    latitude: feature.center.lat,
                    longitude: feature.center.lng,
                    altitude: feature.center.alt
                });
                
                // Create visual based on type
                if (feature.type === 'Polygon') {
                    // Large visible plane
                    entity.setAttribute('geometry', {
                        primitive: 'plane',
                        width: 100,
                        height: 100
                    });
                    entity.setAttribute('material', {
                        color: '#10b981',
                        transparent: true,
                        opacity: 0.6,
                        side: 'double'
                    });
                    entity.setAttribute('rotation', '-90 0 0');
                    
                    // Animated border
                    const border = document.createElement('a-entity');
                    border.setAttribute('geometry', {
                        primitive: 'torus',
                        radius: 55,
                        radiusTubular: 3
                    });
                    border.setAttribute('material', {
                        color: '#ffffff',
                        emissive: '#ffffff'
                    });
                    border.setAttribute('rotation', '-90 0 0');
                    border.setAttribute('animation', {
                        property: 'rotation',
                        to: '-90 360 0',
                        dur: 8000,
                        loop: true
                    });
                    entity.appendChild(border);
                    
                } else if (feature.type === 'Point') {
                    // Large sphere
                    entity.setAttribute('geometry', {
                        primitive: 'sphere',
                        radius: 20
                    });
                    entity.setAttribute('material', {
                        color: '#ef4444',
                        emissive: '#ef4444',
                        emissiveIntensity: 0.3
                    });
                    entity.setAttribute('animation', {
                        property: 'scale',
                        to: '1.2 1.2 1.2',
                        dur: 2000,
                        dir: 'alternate',
                        loop: true
                    });
                }
                
                // Add large label
                const label = document.createElement('a-text');
                label.setAttribute('value', feature.name);
                label.setAttribute('position', '0 25 0');
                label.setAttribute('align', 'center');
                label.setAttribute('color', '#ffffff');
                label.setAttribute('scale', '20 20 20');
                label.setAttribute('material', {
                    color: '#ffffff',
                    transparent: true,
                    opacity: 1
                });
                entity.appendChild(label);
                
                // Calculate distance if GPS available
                if (this.userPosition) {
                    const distance = this.calculateDistance(
                        this.userPosition.lat, this.userPosition.lng,
                        feature.center.lat, feature.center.lng
                    );
                    
                    const distLabel = document.createElement('a-text');
                    distLabel.setAttribute('value', `${distance}m`);
                    distLabel.setAttribute('position', '0 15 0');
                    distLabel.setAttribute('align', 'center');
                    distLabel.setAttribute('color', '#ffff00');
                    distLabel.setAttribute('scale', '15 15 15');
                    entity.appendChild(distLabel);
                    
                    console.log(`📏 ${feature.name}: ${distance}m away`);
                }
                
                this.content.appendChild(entity);
            }

            createTestObjects() {
                this.clearAll();
                
                // Create test objects at fixed positions in front of camera
                const positions = [
                    { x: 0, y: 0, z: -50 },    // Straight ahead
                    { x: -30, y: 0, z: -40 },  // Left
                    { x: 30, y: 0, z: -40 },   // Right
                    { x: 0, y: 20, z: -30 }    // Above
                ];
                
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00'];
                const names = ['ΜΠΡΟΣΤΑ', 'ΑΡΙΣΤΕΡΑ', 'ΔΕΞΙΑ', 'ΠΑΝΩ'];
                
                positions.forEach((pos, i) => {
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
                    entity.setAttribute('data-info', `Test Object ${i + 1}: ${names[i]}`);
                    
                    // Large box
                    entity.setAttribute('geometry', {
                        primitive: 'box',
                        width: 15,
                        height: 15,
                        depth: 15
                    });
                    entity.setAttribute('material', {
                        color: colors[i],
                        emissive: colors[i],
                        emissiveIntensity: 0.4
                    });
                    
                    // Animation
                    entity.setAttribute('animation', {
                        property: 'rotation',
                        to: '360 360 0',
                        dur: 4000,
                        loop: true
                    });
                    
                    // Label
                    const label = document.createElement('a-text');
                    label.setAttribute('value', names[i]);
                    label.setAttribute('position', '0 10 0');
                    label.setAttribute('align', 'center');
                    label.setAttribute('color', '#ffffff');
                    label.setAttribute('scale', '10 10 10');
                    entity.appendChild(label);
                    
                    this.content.appendChild(entity);
                });
                
                this.updateStatus('files', true, 'Αρχεία: 4 δοκιμής');
                this.showInfo('🎯 Δημιουργήθηκαν 4 test objects! Κοιτάξτε γύρω σας - μπροστά, αριστερά, δεξιά, πάνω');
            }

            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371e3;
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lng2-lng1) * Math.PI/180;

                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return Math.round(R * c);
            }

            clearAll() {
                while (this.content.firstChild) {
                    this.content.removeChild(this.content.firstChild);
                }
                this.features = [];
                this.updateStatus('files', false, 'Αρχεία: 0');
                this.showInfo('🗑️ Όλα καθαρίστηκαν');
            }

            updateStatus(type, active, text) {
                const dot = document.getElementById(`${type}-dot`);
                const textEl = document.getElementById(`${type}-text`);
                
                if (active) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
                
                textEl.textContent = text;
            }

            showInfo(message) {
                const info = document.getElementById('info');
                info.innerHTML = message;
                info.classList.add('show');
                
                setTimeout(() => {
                    info.classList.remove('show');
                }, 8000);
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }
        }

        // Initialize when ready
        document.addEventListener('DOMContentLoaded', () => {
            new MapLensAR();
        });
    </script>
</body>
</html>
