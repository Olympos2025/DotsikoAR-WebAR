<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DotsikoAR WebAR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        #loading {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            z-index: 10000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div id="loading">ğŸ”ƒ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· GPS...</div>

    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        embedded>

        <a-camera gps-camera rotation-reader></a-camera>
        <a-entity id="polygons-container"></a-entity>
    </a-scene>

    <script>
    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Eruda Î³Î¹Î± debugging
    document.write('<script src="https://cdn.jsdelivr.net/npm/eruda"><\/script>');
    eruda.init();

    let userPosition = null;

    // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· KML
    async function loadKML(url) {
        try {
            const response = await fetch(url);
            const kmlText = await response.text();
            const parser = new DOMParser();
            const kmlDoc = parser.parseFromString(kmlText, "text/xml");
            
            return Array.from(kmlDoc.querySelectorAll('Placemark')).map(placemark => {
                const coords = placemark.querySelector('coordinates').textContent.trim();
                return coords.split(/\s+/).map(coord => {
                    const [lon, lat] = coord.split(',').map(Number);
                    return { lat, lon };
                });
            });
        } catch (error) {
            console.error("Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ KML:", error);
            alert("Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ KML Î±ÏÏ‡ÎµÎ¯Î¿Ï…");
        }
    }

    // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Î³ÎµÏ‰Î³ÏÎ±Ï†Î¹ÎºÏÎ½ ÏƒÎµ Î¼Î­Ï„ÏÎ±
    function geoToMeters(lat1, lon1, lat2, lon2) {
        const R = 6378137;
        const dLat = (lat2 - lat1) * Math.PI/180;
        const dLon = (lon2 - lon1) * Math.PI/180;
        return {
            x: R * dLon * Math.cos(lat1 * Math.PI/180),
            z: R * dLat
        };
    }

    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± AR Ï€ÎµÏÎ¹ÎµÏ‡Î¿Î¼Î­Î½Î¿Ï…
    async function initAR(position) {
        userPosition = position.coords;
        document.getElementById('loading').textContent = "Î¦ÏŒÏÏ„Ï‰ÏƒÎ· KML...";
        
        const polygons = await loadKML('thermi.kml');
        
        polygons.forEach(polygon => {
            const container = document.createElement('a-entity');
            
            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï€Î¿Î»Ï…Î³ÏÎ½Î¿Ï…
            polygon.forEach((point, index) => {
                const nextPoint = polygon[(index + 1) % polygon.length];
                const {x, z} = geoToMeters(userPosition.latitude, userPosition.longitude, point.lat, point.lon);
                const {x: x2, z: z2} = geoToMeters(userPosition.latitude, userPosition.longitude, nextPoint.lat, nextPoint.lon);
                
                const line = document.createElement('a-entity');
                line.setAttribute('line', {
                    start: `${x} 0 ${z}`,
                    end: `${x2} 0 ${z2}`,
                    color: '#FF0000',
                    opacity: 0.8
                });
                
                container.appendChild(line);
            });

            document.querySelector('#polygons-container').appendChild(container);
        });
        
        document.getElementById('loading').style.display = 'none';
    }

    // Î•ÎºÎºÎ¯Î½Î·ÏƒÎ· ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => initAR(position),
            error => alert("Î§ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î¬Î´ÎµÎ¹Î± GPS"),
            { enableHighAccuracy: true, timeout: 10000 }
        );
    } else {
        alert("Î— ÏƒÏ…ÏƒÎºÎµÏ…Î® ÏƒÎ±Ï‚ Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ geolocation");
    }
    </script>
</body>
</html>
